<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cablemaster Configuratore</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b2a66">

<link rel="icon" href="./favicon.ico" sizes="any">
<link rel="icon" type="image/png" href="./favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="./favicon-16x16.png" sizes="16x16">
<link rel="apple-touch-icon" href="./apple-touch-icon.png">

<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#EFECE7;--srf:#FAFAF8;--brd:#D2CCC4;--txt:#17140E;--mut:#7A746C;
  --acc:#1B3C90;--acc2:#E8EEFF;--gld:#B38A18;--gld2:#FDF2D2;
  --grn:#1A6840;--grn2:#E2F4EC;--red:#8C2818;--red2:#FDEAE6;
  --r:6px;--mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans',sans-serif;
}
body{font-family:var(--sans);background:var(--bg);color:var(--txt);min-height:100vh;font-size:15px}
#app{max-width:980px;margin:0 auto;padding:22px 18px 80px}

/* HEADER */
header{display:flex;align-items:flex-end;justify-content:space-between;border-bottom:2px solid var(--txt);padding-bottom:14px;margin-bottom:0}
.hb{font-family:var(--mono);font-size:.58rem;letter-spacing:.16em;text-transform:uppercase;color:var(--mut)}
.hb strong{display:block;font-family:var(--sans);font-size:1.35rem;font-weight:500;letter-spacing:-.025em;color:var(--txt)}
.hr{font-family:var(--mono);font-size:.56rem;color:var(--mut);text-align:right;line-height:1.7}

/* HOME NAV */
#home-nav{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin:22px 0 0}
.hn{background:var(--srf);border:1.5px solid var(--brd);border-radius:var(--r);padding:20px 16px;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.hn:hover{border-color:var(--acc)}
.hn.active{border-color:var(--acc);box-shadow:0 0 0 2.5px var(--acc)}
.hn-icon{font-size:1.4rem;margin-bottom:9px}
.hn-title{font-size:.95rem;font-weight:600;margin-bottom:3px}
.hn-sub{font-size:.73rem;color:var(--mut);line-height:1.5}
.badge{display:inline-block;font-family:var(--mono);font-size:.52rem;letter-spacing:.08em;padding:2px 7px;border-radius:3px;margin-top:7px;text-transform:uppercase}
.badge.bl{background:var(--acc2);color:var(--acc)}
.badge.gn{background:var(--grn2);color:var(--grn)}

/* CONTENT */
#content{margin-top:24px}

/* STEP NAV */
#snav{display:flex;border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;margin-bottom:24px;background:var(--srf)}
.sn{flex:1;padding:8px 3px;text-align:center;font-family:var(--mono);font-size:.5rem;letter-spacing:.06em;text-transform:uppercase;color:var(--mut);border:none;background:none;cursor:default;border-right:1px solid var(--brd);line-height:1.5;transition:background .15s}
.sn:last-child{border-right:none}
.sn.past{background:var(--grn2);color:var(--grn);cursor:pointer}
.sn.past:hover{background:#cfe8d5}
.sn.cur{background:var(--txt);color:#fff}
.sn.lock{opacity:.28}
.sn.opt{background:#FAF7F0;color:var(--gld)}
.sn.opt.cur{background:var(--txt);color:#fff}
.sn.opt.past{background:var(--grn2);color:var(--grn)}

/* PAGE TITLES */
.stitle{font-size:1.35rem;font-weight:400;letter-spacing:-.025em;margin-bottom:4px}
.shint{font-size:.79rem;color:var(--mut);margin-bottom:18px;line-height:1.6}

/* OPTIONAL BADGE */
.opt-badge{display:inline-block;font-family:var(--mono);font-size:.55rem;letter-spacing:.08em;text-transform:uppercase;background:var(--gld2);color:var(--gld);padding:2px 8px;border-radius:3px;margin-left:10px;vertical-align:middle}

/* CARDS */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:8px;margin-bottom:20px}
.cards.w2{grid-template-columns:repeat(auto-fill,minmax(245px,1fr))}
.card{background:var(--srf);border:1.5px solid var(--brd);border-radius:var(--r);padding:13px;cursor:pointer;transition:border-color .15s,box-shadow .15s;position:relative}
.card:hover{border-color:var(--acc)}
.card.sel{border-color:var(--acc);box-shadow:0 0 0 2px rgba(27,60,144,.2)}
.card.dim{opacity:.28;cursor:not-allowed;pointer-events:none}
.ck{position:absolute;top:9px;right:9px;width:15px;height:15px;border-radius:50%;border:1.5px solid var(--brd);background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:8px;color:transparent}
.card.sel .ck{background:var(--acc);border-color:var(--acc);color:#fff}
.cc{font-family:var(--mono);font-size:.6rem;color:var(--acc);letter-spacing:.04em;margin-bottom:4px}
.cn{font-size:.86rem;font-weight:500;line-height:1.3;margin-bottom:5px}
.cd{font-size:.71rem;color:var(--mut);line-height:1.5}
.tag{display:inline-block;font-family:var(--mono);font-size:.52rem;letter-spacing:.05em;padding:2px 5px;border-radius:3px;margin-top:4px;margin-right:3px}
.tag.b{background:var(--acc2);color:var(--acc)}
.tag.g{background:var(--gld2);color:var(--gld)}
.tag.gr{background:var(--grn2);color:var(--grn)}
.tag.r{background:var(--red2);color:var(--red)}
.tag.n{background:#EDECE9;color:var(--mut)}
/* Clear selection card */
.card-skip{background:none;border:1.5px dashed var(--brd);border-radius:var(--r);padding:13px;cursor:pointer;transition:border-color .15s;display:flex;align-items:center;gap:8px;font-size:.78rem;color:var(--mut)}
.card-skip:hover{border-color:var(--acc);color:var(--acc)}

/* LENGTH */
.lbox{background:var(--srf);border:1px solid var(--brd);border-radius:var(--r);padding:15px;margin-bottom:16px}
.llabel{font-family:var(--mono);font-size:.56rem;letter-spacing:.12em;text-transform:uppercase;color:var(--mut);margin-bottom:9px}
.lbtns{display:flex;flex-wrap:wrap;gap:6px}
.lb{padding:7px 13px;font-family:var(--mono);font-size:.72rem;border:1.5px solid var(--brd);border-radius:var(--r);background:var(--bg);cursor:pointer;transition:all .15s;color:var(--txt)}
.lb:hover{border-color:var(--acc);color:var(--acc)}
.lb.sel{background:var(--acc);border-color:var(--acc);color:#fff}

/* INFO */
.info{display:flex;gap:8px;border-radius:var(--r);padding:10px 12px;font-size:.76rem;line-height:1.55;margin-bottom:12px}
.info.g{background:var(--gld2);border:1px solid #E5C97A;color:#6A4C0E}
.info.b{background:var(--acc2);border:1px solid #C0CFEE;color:#1A3070}
.info.gn{background:var(--grn2);border:1px solid #8ACBAA;color:#1A5530}

/* NAV BUTTONS */
.nav{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:10px;flex-wrap:wrap}
.btn-b{padding:9px 17px;font-family:var(--mono);font-size:.63rem;letter-spacing:.08em;text-transform:uppercase;border:1.5px solid var(--brd);border-radius:var(--r);background:none;color:var(--mut);cursor:pointer;transition:all .15s}
.btn-b:hover{border-color:var(--txt);color:var(--txt)}
.btn-n{padding:10px 22px;font-family:var(--mono);font-size:.63rem;letter-spacing:.08em;text-transform:uppercase;border:none;border-radius:var(--r);background:var(--txt);color:#fff;cursor:pointer;transition:background .15s}
.btn-n:hover{background:var(--acc)}
.btn-r{padding:9px 15px;font-family:var(--mono);font-size:.61rem;letter-spacing:.08em;text-transform:uppercase;border:1.5px solid var(--brd);border-radius:var(--r);background:none;color:var(--mut);cursor:pointer;transition:all .15s}
.btn-r:hover{border-color:var(--red);color:var(--red)}
.btn-acc{padding:10px 20px;font-family:var(--mono);font-size:.63rem;letter-spacing:.08em;text-transform:uppercase;border:none;border-radius:var(--r);background:var(--acc);color:#fff;cursor:pointer;transition:background .15s}
.btn-acc:hover{background:#142e74}
.sep{height:1px;background:var(--brd);margin:14px 0}

/* COPY BAR */
.cbar{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:20px}
.cbtn{padding:8px 14px;font-family:var(--mono);font-size:.6rem;letter-spacing:.08em;text-transform:uppercase;border:1.5px solid var(--brd);border-radius:var(--r);background:var(--srf);color:var(--txt);cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px}
.cbtn:hover{border-color:var(--acc);color:var(--acc)}
.cbtn.ok{border-color:var(--grn);color:var(--grn)}
.cbtn.acc{background:var(--acc);color:#fff;border-color:var(--acc)}
.cbtn.acc:hover{background:#142e74}
.cbtn.gn{background:var(--grn);color:#fff;border-color:var(--grn)}
.cbtn.gn:hover{background:#155c35}

/* BOM TABLE - EDITABLE */
.bom-wrap{position:relative}
.bom-actions{display:flex;gap:7px;margin-bottom:8px;flex-wrap:wrap;align-items:center}
.bom-actions-label{font-family:var(--mono);font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);margin-right:4px}
.bom-add-btn{padding:6px 13px;font-family:var(--mono);font-size:.6rem;letter-spacing:.07em;text-transform:uppercase;border:1.5px solid var(--acc);border-radius:var(--r);background:none;color:var(--acc);cursor:pointer;transition:all .15s}
.bom-add-btn:hover{background:var(--acc);color:#fff}

table{width:100%;border-collapse:collapse;background:var(--srf);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;margin-bottom:14px;font-size:.81rem}
thead th{padding:8px 11px;font-family:var(--mono);font-size:.53rem;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);background:var(--bg);border-bottom:1px solid var(--brd);text-align:left}
tbody td{padding:9px 11px;border-bottom:1px solid var(--brd);vertical-align:middle}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover td{background:#F4F2EE}
.pcode{font-family:var(--mono);font-size:.77rem;color:var(--acc);font-weight:500}
.pcat{font-family:var(--mono);font-size:.53rem;color:var(--mut);letter-spacing:.05em;text-transform:uppercase}
.opt-head td{background:#F7F5F1!important;font-family:var(--mono);font-size:.53rem;letter-spacing:.08em;text-transform:uppercase;color:var(--mut);padding:5px 11px!important}

/* Inline editable cells */
.edit-cell{background:none;border:1px solid transparent;border-radius:3px;padding:3px 6px;font-family:var(--mono);font-size:.77rem;color:var(--acc);width:100%;outline:none;transition:border-color .15s;cursor:text;min-width:80px}
.edit-cell:hover{border-color:var(--brd)}
.edit-cell:focus{border-color:var(--acc);background:var(--bg)}
.edit-desc{background:none;border:1px solid transparent;border-radius:3px;padding:3px 6px;font-family:var(--sans);font-size:.81rem;color:var(--txt);width:100%;outline:none;transition:border-color .15s;cursor:text;min-width:150px}
.edit-desc:hover{border-color:var(--brd)}
.edit-desc:focus{border-color:var(--acc);background:var(--bg)}
.edit-cat{background:none;border:1px solid transparent;border-radius:3px;padding:3px 5px;font-family:var(--mono);font-size:.53rem;color:var(--mut);width:100%;outline:none;cursor:text;text-transform:uppercase}
.edit-cat:focus{border-color:var(--acc);background:var(--bg)}
.qty-input{width:52px;padding:4px 7px;font-family:var(--mono);font-size:.76rem;border:1.5px solid var(--brd);border-radius:4px;background:var(--bg);text-align:center;outline:none}
.qty-input:focus{border-color:var(--acc)}
.rm-btn{padding:4px 8px;font-family:var(--mono);font-size:.56rem;border:1.5px solid var(--brd);border-radius:3px;background:none;cursor:pointer;color:var(--mut);transition:all .15s}
.rm-btn:hover{border-color:var(--red);color:var(--red);background:var(--red2)}

/* SUMMARY HEAD */
.shead{display:grid;grid-template-columns:repeat(5,1fr);gap:1px;background:var(--brd);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;margin-bottom:22px}
.sc{background:var(--srf);padding:11px}
.sc-l{font-family:var(--mono);font-size:.52rem;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);margin-bottom:4px}
.sc-v{font-size:.92rem;font-weight:500;line-height:1.2}
.sc-s{font-size:.66rem;color:var(--mut);margin-top:2px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.48);z-index:100;display:flex;align-items:center;justify-content:center;padding:18px}
.modal{background:var(--srf);border-radius:var(--r);padding:26px;width:100%;max-width:460px;box-shadow:0 20px 60px rgba(0,0,0,.22)}
.modal-title{font-size:1.05rem;font-weight:500;margin-bottom:5px}
.modal-sub{font-size:.77rem;color:var(--mut);margin-bottom:16px;line-height:1.5}
.field{margin-bottom:13px}
.field label{display:block;font-family:var(--mono);font-size:.57rem;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);margin-bottom:5px}
.field input,.field textarea,.field select{width:100%;padding:8px 11px;font-family:var(--sans);font-size:.83rem;border:1.5px solid var(--brd);border-radius:var(--r);background:var(--bg);color:var(--txt);outline:none;transition:border-color .15s}
.field input:focus,.field textarea:focus{border-color:var(--acc)}
.field textarea{resize:vertical;min-height:58px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:18px;flex-wrap:wrap}
.btn-cancel{padding:8px 16px;font-family:var(--mono);font-size:.6rem;letter-spacing:.08em;text-transform:uppercase;border:1.5px solid var(--brd);border-radius:var(--r);background:none;color:var(--mut);cursor:pointer}
.btn-save{padding:8px 20px;font-family:var(--mono);font-size:.6rem;letter-spacing:.08em;text-transform:uppercase;border:none;border-radius:var(--r);background:var(--acc);color:#fff;cursor:pointer}

/* ADD ROW FORM */
.add-row{background:var(--gld2);border:1.5px dashed var(--gld);border-radius:var(--r);padding:14px;margin-bottom:14px;display:none}
.add-row.show{display:block}
.add-row-title{font-family:var(--mono);font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--gld);margin-bottom:11px}
.add-row-grid{display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:8px;align-items:end}
.add-row-grid input,.add-row-grid select{padding:7px 10px;font-family:var(--mono);font-size:.76rem;border:1.5px solid var(--brd);border-radius:var(--r);background:var(--srf);color:var(--txt);outline:none;width:100%}
.add-row-grid input:focus{border-color:var(--acc)}
.btn-add-confirm{padding:8px 14px;font-family:var(--mono);font-size:.6rem;letter-spacing:.07em;text-transform:uppercase;border:none;border-radius:var(--r);background:var(--acc);color:#fff;cursor:pointer;white-space:nowrap}

/* KIT CARDS */
.kit-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:10px;margin-bottom:22px}
.kit-card{background:var(--srf);border:1.5px solid var(--brd);border-radius:var(--r);padding:15px;position:relative}
.kit-card.user-k{border-left:3px solid var(--grn)}
.kit-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:7px}
.kit-name{font-size:.92rem;font-weight:600;line-height:1.3}
.kit-del{width:22px;height:22px;border:none;background:none;color:var(--mut);cursor:pointer;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;flex-shrink:0}
.kit-del:hover{background:var(--red2);color:var(--red)}
.kit-desc{font-size:.73rem;color:var(--mut);line-height:1.5;margin-bottom:9px}
.kit-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px}
.kit-items{font-family:var(--mono);font-size:.6rem;color:var(--mut);border-top:1px solid var(--brd);padding-top:8px;line-height:1.75}
.kit-cta{display:flex;gap:6px;margin-top:9px;flex-wrap:wrap}
.btn-kit{padding:6px 13px;font-family:var(--mono);font-size:.58rem;letter-spacing:.08em;text-transform:uppercase;border:none;border-radius:var(--r);cursor:pointer;transition:all .15s}
.btn-kit.primary{background:var(--txt);color:#fff}
.btn-kit.primary:hover{background:var(--acc)}
.btn-kit.sec{background:none;border:1.5px solid var(--brd);color:var(--mut)}
.btn-kit.sec:hover{border-color:var(--acc);color:var(--acc)}
.btn-kit.share{background:var(--grn2);color:var(--grn);border:1.5px solid var(--grn)}
.btn-kit.share:hover{background:var(--grn);color:#fff}

/* CATALOG */
.cat-search{margin-bottom:12px}
.cat-search input{width:100%;padding:9px 12px;font-family:var(--sans);font-size:.84rem;border:1.5px solid var(--brd);border-radius:var(--r);background:var(--srf);color:var(--txt);outline:none}
.cat-search input:focus{border-color:var(--acc)}
.cat-filter{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:14px}
.cf{padding:5px 12px;font-family:var(--mono);font-size:.58rem;letter-spacing:.07em;text-transform:uppercase;border:1.5px solid var(--brd);border-radius:var(--r);background:var(--srf);color:var(--mut);cursor:pointer;transition:all .15s}
.cf:hover{border-color:var(--acc);color:var(--acc)}
.cf.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.add-btn{padding:4px 10px;font-family:var(--mono);font-size:.56rem;letter-spacing:.05em;border:1.5px solid var(--brd);border-radius:3px;background:none;cursor:pointer;color:var(--mut);transition:all .15s;white-space:nowrap}
.add-btn:hover{border-color:var(--grn);color:var(--grn)}
.add-btn.added{border-color:var(--grn);color:var(--grn);background:var(--grn2)}

/* CART BAR */
.cart-bar{position:fixed;bottom:0;left:0;right:0;background:var(--txt);color:#fff;padding:12px 22px;display:flex;align-items:center;justify-content:space-between;gap:12px;z-index:50;transform:translateY(100%);transition:transform .2s}
.cart-bar.show{transform:translateY(0)}
.cart-lbl{font-family:var(--mono);font-size:.68rem;letter-spacing:.07em}
.cart-n{display:inline-block;background:var(--acc);color:#fff;font-family:var(--mono);font-size:.62rem;padding:2px 7px;border-radius:20px;margin-left:7px}

/* IMPORT/SHARE */
.import-area{border:2px dashed var(--brd);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;transition:border-color .15s;margin-bottom:14px}
.import-area:hover{border-color:var(--acc)}
.import-area input{display:none}

@media(max-width:600px){
  #home-nav{grid-template-columns:1fr}
  .cards,.cards.w2,.kit-grid{grid-template-columns:1fr}
  .shead{grid-template-columns:1fr 1fr}
  #snav{flex-wrap:wrap}
  .sn{font-size:.48rem;padding:6px 2px}
  header{flex-direction:column;gap:7px;align-items:flex-start}
  .add-row-grid{grid-template-columns:1fr 1fr;grid-template-rows:auto auto auto}
}

/* CATALOG OVERLAY DRAWER */
.cat-drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:300;display:flex;justify-content:flex-end}
.cat-drawer{background:var(--srf);width:100%;max-width:540px;height:100%;display:flex;flex-direction:column;box-shadow:-6px 0 28px rgba(0,0,0,.16);animation:slideIn .2s ease}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
.cat-drawer-head{padding:14px 18px 11px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:12px}
.cat-drawer-title{font-size:.95rem;font-weight:500;letter-spacing:-.015em}
.cat-drawer-close{width:28px;height:28px;border:none;background:none;color:var(--mut);cursor:pointer;font-size:17px;border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cat-drawer-close:hover{background:var(--red2);color:var(--red)}
.cat-drawer-body{padding:13px 16px;overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch}
.cat-drawer-body .cat-search input{background:var(--bg);font-size:.82rem;padding:8px 10px}
.cat-drawer-body .cat-filter{gap:4px;margin-bottom:10px}
.cat-drawer-body .cf{padding:4px 9px;font-size:.55rem}
.cat-drawer-body table{font-size:.78rem}
.cat-drawer-body thead th{font-size:.51rem;padding:7px 9px}
.cat-drawer-body tbody td{padding:7px 9px}
.cat-drawer-body .add-btn{padding:4px 9px;font-size:.54rem}
.cat-drawer-footer{padding:10px 16px;border-top:1px solid var(--brd);flex-shrink:0;font-family:var(--mono);font-size:.6rem;color:var(--grn);min-height:38px;display:flex;align-items:center}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#admin-panel{position:fixed;inset:0;background:var(--bg);z-index:500;display:none;flex-direction:column;overflow:hidden}
#admin-panel.show{display:flex}
.adm-head{background:var(--txt);color:#fff;padding:12px 20px;display:flex;align-items:center;gap:14px;flex-shrink:0}
.adm-head-title{font-family:var(--mono);font-size:.65rem;letter-spacing:.15em;text-transform:uppercase;flex:1}
.adm-head-ver{font-family:var(--mono);font-size:.55rem;opacity:.55}
.adm-close{width:28px;height:28px;border:none;background:rgba(255,255,255,.12);color:#fff;cursor:pointer;border-radius:4px;font-size:16px;display:flex;align-items:center;justify-content:center}
.adm-close:hover{background:rgba(255,255,255,.22)}
.adm-tabs{display:flex;border-bottom:2px solid var(--brd);background:var(--srf);flex-shrink:0}
.adm-tab{padding:10px 18px;font-family:var(--mono);font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;border:none;background:none;color:var(--mut);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
.adm-tab:hover{color:var(--txt)}
.adm-tab.on{color:var(--acc);border-bottom-color:var(--acc);font-weight:500}
.adm-body{flex:1;overflow-y:auto;padding:20px}
/* editor */
.adm-toolbar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.adm-search{flex:1;min-width:180px;padding:7px 11px;font-family:var(--sans);font-size:.82rem;border:1.5px solid var(--brd);border-radius:var(--r);background:var(--srf);color:var(--txt);outline:none}
.adm-search:focus{border-color:var(--acc)}
.adm-filter{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px}
.adm-cf{padding:4px 10px;font-family:var(--mono);font-size:.55rem;letter-spacing:.06em;text-transform:uppercase;border:1.5px solid var(--brd);border-radius:var(--r);background:var(--srf);color:var(--mut);cursor:pointer;transition:all .15s}
.adm-cf:hover{border-color:var(--acc);color:var(--acc)}
.adm-cf.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.adm-table{width:100%;border-collapse:collapse;background:var(--srf);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;font-size:.79rem;margin-bottom:16px}
.adm-table thead th{padding:8px 10px;font-family:var(--mono);font-size:.51rem;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);background:var(--bg);border-bottom:1px solid var(--brd);text-align:left;white-space:nowrap}
.adm-table tbody td{padding:7px 10px;border-bottom:1px solid var(--brd);vertical-align:middle}
.adm-table tbody tr:last-child td{border-bottom:none}
.adm-table tbody tr.inactive td{opacity:.45}
.adm-table tbody tr:hover td{background:#F4F2EE}
.adm-edit{background:none;border:1px solid transparent;border-radius:3px;padding:3px 6px;font-family:inherit;font-size:inherit;color:inherit;width:100%;outline:none;cursor:text}
.adm-edit:hover{border-color:var(--brd)}
.adm-edit:focus{border-color:var(--acc);background:var(--bg)}
.adm-cod{font-family:var(--mono);font-size:.72rem;color:var(--acc)}
.adm-toggle{width:34px;height:18px;border-radius:9px;border:none;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0}
.adm-toggle.on{background:var(--grn)}
.adm-toggle.off{background:var(--brd)}
.adm-toggle::after{content:'';position:absolute;top:3px;width:12px;height:12px;border-radius:50%;background:#fff;transition:left .2s}
.adm-toggle.on::after{left:19px}
.adm-toggle.off::after{left:3px}
.adm-sub-inp{background:none;border:1px solid transparent;border-radius:3px;padding:3px 6px;font-family:var(--mono);font-size:.65rem;color:var(--mut);width:100%;outline:none;cursor:text}
.adm-sub-inp:hover{border-color:var(--brd)}
.adm-sub-inp:focus{border-color:var(--acc);background:var(--bg)}
/* diff */
.diff-wrap{display:flex;flex-direction:column;gap:12px;margin-bottom:16px}
.diff-section{border:1.5px solid var(--brd);border-radius:var(--r);overflow:hidden}
.diff-head{padding:10px 14px;font-family:var(--mono);font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;display:flex;align-items:center;gap:8px}
.diff-head.new{background:var(--grn2);color:var(--grn);border-bottom:1px solid #A8D8BB}
.diff-head.changed{background:#FFF8E6;color:#8A6000;border-bottom:1px solid #E5C97A}
.diff-head.removed{background:var(--red2);color:var(--red);border-bottom:1px solid #F0B8AE}
.diff-head.ok{background:var(--acc2);color:var(--acc);border-bottom:1px solid #B0C4EE}
.diff-count{font-size:.75rem;font-weight:600}
.diff-rows{}
.diff-row{display:grid;grid-template-columns:140px 1fr 1fr;padding:8px 14px;border-bottom:1px solid var(--brd);font-size:.76rem;gap:10px;align-items:center}
.diff-row:last-child{border-bottom:none}
.diff-cod{font-family:var(--mono);font-size:.68rem;color:var(--acc)}
.diff-old{color:var(--red);text-decoration:line-through;font-size:.73rem}
.diff-new{color:var(--grn);font-size:.73rem}
/* audit */
.audit-kit{background:var(--srf);border:1.5px solid var(--brd);border-radius:var(--r);padding:14px;margin-bottom:10px}
.audit-kit.warn{border-color:var(--gld);background:var(--gld2)}
.audit-kit.err{border-color:var(--red);background:var(--red2)}
.audit-kit.ok{border-color:var(--grn);background:var(--grn2)}
.audit-kit-name{font-weight:600;font-size:.88rem;margin-bottom:6px}
.audit-issue{display:flex;align-items:flex-start;gap:8px;font-size:.74rem;margin-top:6px;padding:5px 8px;border-radius:4px;background:rgba(255,255,255,.5)}
.audit-issue-cod{font-family:var(--mono);font-size:.65rem;color:var(--acc);flex-shrink:0;min-width:110px}
/* export bar */
.adm-export-bar{display:flex;gap:8px;flex-wrap:wrap;padding:14px 20px;border-top:1px solid var(--brd);background:var(--srf);flex-shrink:0}
</style>
</head>
<body>
<div id="app">
<header>
  <div class="hb">Configuratore<strong>Cablemasterâ„¢</strong></div>
  <div class="hr">Made with â¤ï¸ by DF Â· IT Â· Rev. 2 Â· 2026</div>
</header>
<div id="home-nav"></div>
<div id="content"></div>
</div>

<div class="overlay" id="save-modal" style="display:none">
  <div class="modal">
    <div class="modal-title">Salva come Kit</div>
    <div class="modal-sub">Il kit verrÃ  salvato localmente e sarÃ  condivisibile tramite link o CSV.</div>
    <div class="field"><label>Nome Kit</label><input id="kit-name-in" placeholder="es. CM8 100A USA AZ S7 25m"></div>
    <div class="field"><label>Note (cliente, progetto, ecc.)</label><textarea id="kit-notes-in" placeholder="Note opzionaliâ€¦"></textarea></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Annulla</button>
      <button class="btn-save" onclick="doSaveKit()">ğŸ’¾ Salva</button>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="admin-panel">
  <div class="adm-head">
    <div class="adm-head-title">âš™ï¸ &nbsp;Admin â€” Gestione Catalogo</div>
    <span class="adm-head-ver" id="adm-ver"></span>
    <button class="adm-close" onclick="closeAdmin()">Ã—</button>
  </div>
  <div class="adm-tabs">
    <button class="adm-tab on" onclick="admTab('editor',this)">ğŸ“‹ Editor articoli</button>
    <button class="adm-tab" onclick="admTab('import',this)">â¬† Import CSV</button>
    <button class="adm-tab" onclick="admTab('audit',this)">ğŸ” Audit kit</button>
  </div>
  <div class="adm-body" id="adm-body"></div>
  <div class="adm-export-bar" id="adm-export-bar">
    <button class="cbtn acc" onclick="admExportJSON()">â¬‡ Esporta catalog.json</button>
    <button class="cbtn" onclick="admExportCSV()">â¬‡ Esporta CSV</button>
    <span style="font-family:var(--mono);font-size:.58rem;color:var(--mut);align-self:center" id="adm-save-status"></span>
  </div>
</div>

<div class="cart-bar" id="cart-bar">
  <div class="cart-lbl">Selezione catalogo <span class="cart-n" id="cart-n">0</span></div>
  <button class="cbtn" style="color:#fff;border-color:rgba(255,255,255,.35);background:transparent" onclick="setMode('cart')">Vedi lista â†’</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATI â€” caricati da catalog.json + rules.json
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DB = {};
let PRESETS = [];
let CATALOG_ITEMS = [];
let RULES = {};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STEPS=['Motore','Tensione','Cavo','Lunghezza','Connettore','Hawse','Contenitore','Riepilogo'];
// step 4 = connettore (spina+presa insieme), step 5 = hawse (opt), step 6 = cont (opt)
const OPT_STEPS=[4,5,6];

let MODE='home';
let W={s:0,motore:null,ten:null,cavo:null,lun:null,conn:null,conn_variant:'main',hawse:null,cont:null};
let BOM=[]; // array di {cat,cod,d,qty}
let CART={}; // catalogo libero
let CAT_F='Tutto', CAT_Q='';
let SHOW_ADD_ROW=false;

const getUserKits=()=>{try{return JSON.parse(localStorage.getItem('cm_kits6')||'[]');}catch{return[];}};
const saveUserKits=kits=>localStorage.setItem('cm_kits6',JSON.stringify(kits));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ROOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  renderHNav();
  if(MODE==='home') rHome();
  else if(MODE==='wizard') rWizard();
  else if(MODE==='kits') rKits();
  else if(MODE==='catalog') rCatalog();
  else if(MODE==='cart') rCart();
  else if(MODE==='kit-detail') rKitDetail();
}

function renderHNav(){
  const uk=getUserKits(),cc=Object.keys(CART).length;
  document.getElementById('home-nav').innerHTML=`
    <div class="hn ${MODE==='wizard'?'active':''}" onclick="setMode('wizard')">
      <div class="hn-icon">ğŸ”§</div><div class="hn-title">Componi configurazione</div>
      <div class="hn-sub">Wizard guidato. Salva la BOM come kit al termine.</div>
      <span class="badge bl">Wizard</span>
    </div>
    <div class="hn ${MODE==='kits'||MODE==='kit-detail'?'active':''}" onclick="setMode('kits')">
      <div class="hn-icon">ğŸ“¦</div><div class="hn-title">Kit preconfigurati</div>
      <div class="hn-sub">Scegli un kit standard o usa i tuoi kit salvati.</div>
      ${uk.length?`<span class="badge gn">${uk.length} kit salvat${uk.length===1?'o':'i'}</span>`:`<span class="badge bl">${PRESETS.length} preset</span>`}
    </div>
    <div class="hn ${MODE==='catalog'||MODE==='cart'?'active':''}" onclick="setMode('catalog')">
      <div class="hn-icon">ğŸ—‚</div><div class="hn-title">Catalogo articoli</div>
      <div class="hn-sub">Ricerca libera su tutto il catalogo in stock.</div>
      ${cc?`<span class="badge gn">${cc} selezionat${cc===1?'o':'i'}</span>`:`<span class="badge bl">Ricerca libera</span>`}
    </div>`;
}

function setMode(m){
  MODE=m;
  if(m==='wizard'){W={s:0,motore:null,ten:null,cavo:null,lun:null,conn:null,conn_variant:'main',hawse:null,cont:null};BOM=[];SHOW_ADD_ROW=false;}
  render();
}

function rHome(){document.getElementById('content').innerHTML=`<div style="padding:36px 0 0;text-align:center;color:var(--mut);font-size:.8rem;line-height:1.7">Seleziona una modalitÃ  per iniziare.</div>`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rWizard(){
  const fns=[wS0,wS1,wS2,wS3,wS4,wS5,wS6,wSummary];
  document.getElementById('content').innerHTML=`
    <div id="snav">${STEPS.map((n,i)=>{
      const isOpt=OPT_STEPS.includes(i);
      let c='sn'+(isOpt?' opt':'');
      if(i===W.s)c+=' cur';else if(i<W.s)c+=' past';else c+=' lock';
      const label=isOpt?`${i+1}. ${n} <span style="font-size:.48rem;opacity:.7">(opt)</span>`:`${i+1}. ${n}`;
      return`<button class="${c}"${i<W.s?` onclick="wGo(${i})"`:' disabled'}>${label}</button>`;
    }).join('')}</div>
    <div id="wb">${(W.s===7)?"":fns[W.s]()}</div>`;
  wBind();
  if(W.s===7){ wSummary(true); }
  window.scrollTo(0,0);
}

function wGo(n){
  W.s=n;
  if(n<=0)W.motore=null;if(n<=1)W.ten=null;if(n<=2)W.cavo=null;
  if(n<=3)W.lun=null;if(n<=4){W.conn=null;W.conn_variant='main';}
  if(n<=5)W.hawse=null;if(n<=6)W.cont=null;
  rWizard();
}
const wN=()=>{W.s++;rWizard();};
const wB=()=>wGo(W.s-1);
const wNav=(key,opt)=>`
  <div class="nav">
    ${W.s>0?`<button class="btn-b" onclick="wB()">â† Indietro</button>`:'<span></span>'}
    <button class="btn-n" onclick="wN()" ${(!W[key]&&!opt)?'disabled':''}>
      ${opt&&!W[key]?'Salta â†’':'Avanti â†’'}
    </button>
  </div>`;

const idOf=(t,o)=>Object.keys(t).find(k=>t[k]===o);

// â”€â”€ QUERY ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Restituisce tag HTML mercato da stringa "USA+EU" o array ["USA","EU"]
function mktag(m){
  const list=Array.isArray(m)?m:String(m).split('+');
  return (list.includes('USA')?'<span class="tag gr">USA</span>':'')+
         (list.includes('EU')?'<span class="tag g">EU</span>':'');
}

// Cavi compatibili con un motore: OD cavo <= OD max motore, articolo attivo
function queryCavi(motoreId){
  const m=DB.motori[motoreId];
  if(!m) return [];
  return Object.entries(DB.cavi)
    .filter(([id,c])=>{
      const od=c.attrs?c.attrs.od:c.od;
      return od<=m.od_max;
    })
    .map(([id,c])=>({id,c}));
}

// Gruppo connettore per un cavo: legge attrs.gruppo_conn oppure c.conn
function getGruppoConn(cavoId){
  const c=DB.cavi[cavoId];
  if(!c) return null;
  const gid=(c.attrs&&c.attrs.gruppo_conn)||c.conn;
  return gid?{id:gid, conn:DB.connettori[gid]}:null;
}

// Hawse compatibili: motore giusto + OD max >= OD cavo
function queryHawse(motoreId, cavoId){
  const cavo=DB.cavi[cavoId];
  const od=cavo?(cavo.attrs?cavo.attrs.od:cavo.od):0;
  return Object.entries(DB.hawse)
    .filter(([id,h])=>{
      const motori=h.attrs?h.attrs.motori:(h.motori||h.m||[]);
      const odmax=h.attrs?h.attrs.od_max:(h.od||999);
      return motori.includes(motoreId)&&odmax>=0; // mostra tutti, dim se OD incompatibile
    })
    .map(([id,h])=>({id,h}));
}

// Contenitori compatibili con motore
function queryContenitori(motoreId){
  return Object.entries(DB.cont)
    .filter(([id,ct])=>{
      const motori=ct.attrs?ct.attrs.motori:(ct.motori||ct.m||[]);
      return motori.includes(motoreId);
    })
    .map(([id,ct])=>({id,ct}));
}

// Valuta vincoli da rules.json e aggiunge righe BOM obbligatorie
function valutaVincoli(motoreId, cavoId){
  const extra=[];
  if(!RULES.vincoli) return extra;
  const cavo=DB.cavi[cavoId]||{};
  const poli=cavo.attrs?cavo.attrs.poli:cavo.poli;
  for(const v of RULES.vincoli){
    let ok=false;
    if(v.id==='CM8_5poli_kit') ok=(motoreId==='CM8'&&poli===5);
    // pattern generico future-proof
    if(ok) extra.push({cat:v.obbligatorio.cat,cod:v.obbligatorio.cod,d:v.obbligatorio.d,qty:1});
  }
  return extra;
}

// Valuta suggerimenti da rules.json
function valutaSuggerimenti(motoreId, cavoId, lunM){
  const sug=[];
  if(!RULES.suggerimenti) return sug;
  const cavo=DB.cavi[cavoId]||{};
  const amp=cavo.attrs?cavo.attrs.amp:cavo.amp;
  for(const r of RULES.suggerimenti){
    let match=false;
    if(r.condizione==='sempre') match=true;
    else if(r.condizione==='cavo.lun_m > 20') match=(lunM>20);
    else if(r.condizione==="motore == 'CM8'") match=(motoreId==='CM8');
    if(!match) continue;
    for(const a of (r.articoli||[])){
      let take=true;
      if(a.se==='cavo.amp <= 50') take=(amp<=50);
      else if(a.se==='cavo.amp > 50') take=(amp>50);
      if(take) sug.push({cat:a.cat,cod:a.cod,d:CATALOG_ITEMS.find(x=>x.cod===a.cod)?.d||a.cod,qty:1});
    }
  }
  return sug;
}

function wS0(){return`
  <div class="stitle">Seleziona il motore</div>
  <div class="shint">Il modello determina il diametro massimo del cavo e gli accessori compatibili.</div>
  <div class="cards">${Object.values(DB.motori).map(m=>`
    <div class="card ${W.motore===m.label?'sel':''}" data-k="motore" data-v="${m.label}">
      <div class="ck">${W.motore===m.label?'âœ“':''}</div>
      <div class="cc">${m.label}</div><div class="cn">${m.desc}</div>
      <div class="cd">${m.sub}</div>
      ${m.note?`<span class="tag g">â„¹ ${m.note}</span>`:''}
    </div>`).join('')}</div>
  <div class="nav"><span></span><button class="btn-n" onclick="wN()" ${!W.motore?'disabled':''}>Avanti â†’</button></div>`;}

function wS1(){
  const m=DB.motori[W.motore];return`
  <div class="stitle">Tensione di alimentazione</div>
  <div class="shint">Definisce il codice avvolgicavo da ordinare.</div>
  <div class="cards">${Object.entries(m.t).map(([l,c])=>`
    <div class="card ${W.ten===l?'sel':''}" data-k="ten" data-v="${l}">
      <div class="ck">${W.ten===l?'âœ“':''}</div>
      <div class="cc">${c}</div><div class="cn">${l}</div><div class="cd">${m.desc}</div>
    </div>`).join('')}</div>
  ${wNav('ten')}`;}

function wS2(){
  const m=DB.motori[W.motore];
  // Query dinamica: tutti i cavi con OD <= od_max del motore
  const cavi=queryCavi(W.motore);
  return`
  <div class="stitle">Tipo di cavo</div>
  <div class="shint">Cavi compatibili con <strong>${m.label}</strong> Â· OD max ${m.od_max}mm.</div>
  <div class="cards w2">${cavi.map(({id,c})=>{
    const at=c.attrs||{};
    const od=at.od||c.od, amp=at.amp||c.amp, poli=at.poli||c.poli;
    const mkt=at.mercato||c.mkt||[];
    return`
    <div class="card ${W.cavo===id?'sel':''}" data-k="cavo" data-v="${id}">
      <div class="ck">${W.cavo===id?'âœ“':''}</div>
      <div class="cc">${c.p||id}</div><div class="cn">${c.d}</div>
      <div class="cd">${c.spec||''}<br>OD ${od}mm Â· ${poli} cond. Â· ${amp}A</div>
      ${mktag(mkt)}
      ${c.note?`<div style="margin-top:5px"><span class="tag g">âš  ${c.note}</span></div>`:''}
    </div>`}).join('')}</div>
  ${wNav('cavo')}`;}

function wS3(){
  const c=DB.cavi[W.cavo];const sel=W.lun;return`
  <div class="stitle">Lunghezza cavo</div>
  <div class="shint">Disponibili dal listino per <strong>${c.d}</strong>.</div>
  <div class="lbox">
    <div class="llabel">Seleziona lunghezza</div>
    <div class="lbtns">${c.lun.map(l=>{
      const s=sel&&sel.c===l.c&&sel.m===l.m;
      return`<button class="lb ${s?'sel':''}" data-k="lun" data-v='${JSON.stringify(l)}'>${l.m}m${l.n?` <small style="opacity:.6">(${l.n})</small>`:''}</button>`;
    }).join('')}</div>
    ${sel?`<div style="margin-top:10px;font-size:.76rem;color:var(--mut)">Codice: <strong style="color:var(--acc);font-family:var(--mono)">${sel.c}</strong> Â· ${sel.m}m</div>`:''}
  </div>
  ${c.note?`<div class="info g">âš  ${c.note}</div>`:''}
  ${wNav('lun')}`;}

function wS4(){
  // Query dinamica: gruppo connettore dal campo attrs.gruppo_conn del cavo
  const gc=getGruppoConn(W.cavo);
  if(!gc||!gc.conn){
    return`<div class="stitle">Connettori <span class="opt-badge">Opzionale</span></div>
    <div class="shint">Nessun connettore standard trovato per questo cavo. Aggiungilo manualmente nel riepilogo.</div>
    <div class="nav"><button class="btn-b" onclick="wB()">â† Indietro</button><button class="btn-n" onclick="wN()">Salta â†’</button></div>`;
  }
  const conn=gc.conn;
  // Costruisce varianti dinamicamente da tutti i campi alt_sp* presenti nel connettore
  const varianti=[{key:'main',label:conn.nome+' (standard)',sp:conn.spina,pv:conn.presa_v,pf:conn.presa_f}];
  ['alt_sp','alt_sp2','alt_sp3'].forEach((k,i)=>{
    if(conn[k]) varianti.push({
      key:'alt'+(i===0?'':i+1),
      label:conn[k].d,
      sp:conn[k],
      pv:conn[k].presa_v||conn.presa_v,
      pf:conn[k].presa_f||conn.presa_f
    });
  });

  return`
  <div class="stitle">Connettori <span class="opt-badge">Opzionale</span></div>
  <div class="shint">Spina (maschio Â· banchina) e presa (femmina Â· bordo) dello stesso standard. Puoi saltare.</div>
  <div class="cards w2">${varianti.map(v=>{
    const isSel=W.conn===v.key;
    return`<div class="card ${isSel?'sel':''}" data-k="conn" data-v="${v.key}">
      <div class="ck">${isSel?'âœ“':''}</div>
      <div class="cn" style="font-size:.82rem">${v.label}</div>
      <div class="cd" style="margin-top:5px">
        <span style="color:var(--acc);font-family:var(--mono)">${v.sp.cod}</span>
        <span style="color:var(--mut)"> Â· ${v.sp.marca||''}</span><br>
        <span style="font-size:.7rem;color:var(--mut)">â†• Presa bordo: </span>
        <span style="color:var(--acc);font-family:var(--mono);font-size:.72rem">${v.pv?v.pv.cod:'â€”'}</span>
        ${v.sp.cap?`<br><span style="font-size:.68rem;color:var(--mut)">+ cappuccio: ${v.sp.cap}</span>`:''}
      </div>
      ${conn.note?`<span class="tag g">${conn.note}</span>`:''}
    </div>`;}).join('')}
    <div class="card-skip" onclick="W.conn=null;W.conn_variant='main';wN()">
      â†· Salta â€” aggiungerÃ² connettori manualmente
    </div>
  </div>
  <div class="nav">
    <button class="btn-b" onclick="wB()">â† Indietro</button>
    <button class="btn-n" onclick="wN()">${!W.conn?'Salta â†’':'Avanti â†’'}</button>
  </div>`;}

function wS5(){
  const c=DB.cavi[W.cavo];
  const cavoOd=c.attrs?c.attrs.od:c.od;
  // Query dinamica: hawse compatibili con il motore selezionato
  const list=queryHawse(W.motore, W.cavo);
  return`
  <div class="stitle">Hawse Pipe <span class="opt-badge">Opzionale</span></div>
  <div class="shint">Alloggiamento stagno che protegge la spina a cavo retratto. OD cavo: <strong>${cavoOd}mm</strong>.</div>
  <div class="cards w2">${list.map(({id,h})=>{
    const odmax=h.attrs?h.attrs.od_max:h.od;
    const fit=cavoOd<=odmax;
    return`<div class="card ${!fit?'dim':''} ${W.hawse===id?'sel':''}" data-k="hawse" data-v="${id}">
      <div class="ck">${W.hawse===id?'âœ“':''}</div>
      <div class="cc">${h.c}</div><div class="cn">${h.d}</div>
      <div class="cd">OD max: <strong>${odmax}mm</strong> Â· cavo: ${cavoOd}mm</div>
      ${!fit?'<span class="tag r">âš  OD superiore al limite</span>':''}
      ${h.note?`<span class="tag g">${h.note}</span>`:''}
    </div>`;}).join('')}
    <div class="card-skip" onclick="W.hawse=null;wN()">â†· Salta</div>
  </div>
  <div class="nav">
    <button class="btn-b" onclick="wB()">â† Indietro</button>
    <button class="btn-n" onclick="wN()">${!W.hawse?'Salta â†’':'Avanti â†’'}</button>
  </div>`;}

function wS6(){
  const m=DB.motori[W.motore];
  // Query dinamica: contenitori compatibili col motore
  const list=queryContenitori(W.motore);
  return`
  <div class="stitle">Contenitore <span class="opt-badge">Opzionale</span></div>
  <div class="shint">Contenitore di stoccaggio compatibile con <strong>${m.label}</strong>.</div>
  <div class="cards">${list.map(({id,ct})=>`
    <div class="card ${W.cont===id?'sel':''}" data-k="cont" data-v="${id}">
      <div class="ck">${W.cont===id?'âœ“':''}</div>
      <div class="cc">${ct.c}</div><div class="cn">${ct.d}</div>
      <div class="cd">${ct.dim}</div>
      ${ct.note?`<span class="tag g">${ct.note}</span>`:''}
    </div>`).join('')}
    <div class="card-skip" onclick="W.cont=null;wN()">â†· Salta</div>
  </div>
  <div class="nav">
    <button class="btn-b" onclick="wB()">â† Indietro</button>
    <button class="btn-n" onclick="wN()">${!W.cont?'Salta â†’':'Riepilogo â†’'}</button>
  </div>`;}

function wSummary(embed){
  const m=DB.motori[W.motore], c=DB.cavi[W.cavo];
  const lunM=W.lun?W.lun.m:0;

  // Risolve variante connettore dinamicamente
  let connV=null;
  if(W.conn){
    const gc=getGruppoConn(W.cavo);
    if(gc&&gc.conn){
      const conn=gc.conn;
      const varianti=[
        {key:'main',sp:conn.spina,pv:conn.presa_v},
        {key:'alt', sp:conn.alt_sp,  pv:(conn.alt_sp&&conn.alt_sp.presa_v)||conn.presa_v},
        {key:'alt2',sp:conn.alt_sp2, pv:(conn.alt_sp2&&conn.alt_sp2.presa_v)||conn.presa_v},
        {key:'alt3',sp:conn.alt_sp3, pv:(conn.alt_sp3&&conn.alt_sp3.presa_v)||conn.presa_v},
      ];
      connV=varianti.find(v=>v.key===W.conn_variant&&v.sp)||null;
    }
  }

  const h=W.hawse?DB.hawse[W.hawse]:null;
  const ct=W.cont?DB.cont[W.cont]:null;
  const ten=m.tensioni||m.t||{};

  BOM=[];
  BOM.push({cat:'Avvolgicavo',cod:ten[W.ten],d:`${m.desc} Â· ${W.ten}`,qty:1});
  if(W.lun) BOM.push({cat:'Cavo',cod:W.lun.c,d:`${c.d} Â· ${W.lun.m}m${W.lun.n?' ('+W.lun.n+')':''}`,qty:1});
  if(connV&&connV.sp){
    BOM.push({cat:'Spina (banchina)',cod:connV.sp.cod,d:connV.sp.d,qty:1});
    if(connV.sp.cap) BOM.push({cat:'Cappuccio spina',cod:connV.sp.cap,d:'Cappuccio protezione spina',qty:1});
    if(connV.pv) BOM.push({cat:'Presa (bordo)',cod:connV.pv.cod,d:connV.pv.d,qty:1});
  }
  if(h) BOM.push({cat:'Hawse Pipe',cod:h.c,d:h.d,qty:1});
  if(ct) BOM.push({cat:'Contenitore',cod:ct.c,d:`${ct.d} Â· ${ct.dim}`,qty:1});

  // Vincoli da rules.json (es. kit 04041 per CM8 + 5 poli)
  valutaVincoli(W.motore, W.cavo).forEach(r=>BOM.push(r));

  // Suggerimenti da rules.json
  const sug=valutaSuggerimenti(W.motore, W.cavo, lunM);

  window._SUG=sug;
  window._WLABEL=`${W.motore} ${W.ten}${W.lun?' Â· '+W.lun.m+'m':''}`;
  renderBOM(!!embed);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOM EDITOR (condiviso tra wizard e kit-detail e cart)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBOM(isKitView){
  const sug=window._SUG||[];
  const label=window._WLABEL||'';

  const rows=BOM.map((row,i)=>`
    <tr>
      <td><input class="edit-cat" value="${esc(row.cat)}" oninput="BOM[${i}].cat=this.value"></td>
      <td><input class="edit-cell" value="${esc(row.cod)}" oninput="BOM[${i}].cod=this.value"></td>
      <td><input class="edit-desc" value="${esc(row.d)}" oninput="BOM[${i}].d=this.value"></td>
      <td><input class="qty-input" type="number" min="1" value="${row.qty||1}" oninput="BOM[${i}].qty=Math.max(1,parseInt(this.value)||1)"></td>
      <td><button class="rm-btn" onclick="bomRemove(${i})">âœ•</button></td>
    </tr>`).join('');

  const sugRows=sug.map(p=>`
    <tr style="opacity:.58">
      <td><span class="pcat" style="color:var(--gld)">${p.cat}</span></td>
      <td><span class="pcode" style="color:var(--gld)">${p.cod}</span></td>
      <td>${p.d}</td>
      <td>â€”</td>
      <td><button class="add-btn" onclick="bomAddSug(${JSON.stringify(p).replace(/"/g,'&quot;')})">+ aggiungi</button></td>
    </tr>`).join('');

  const addForm=`
    <div class="add-row ${SHOW_ADD_ROW?'show':''}" id="add-row-box">
      <div class="add-row-title">Aggiungi riga manuale</div>
      <div class="add-row-grid">
        <input id="ar-cat" placeholder="Categoria" list="cat-list">
        <datalist id="cat-list"><option>Avvolgicavo</option><option>Cavo</option><option>Spina (banchina)</option><option>Presa (bordo)</option><option>Hawse Pipe</option><option>Contenitore</option><option>Accessorio</option><option>Guida rulli</option><option>Controllo</option></datalist>
        <input id="ar-cod" placeholder="Codice" style="font-family:var(--mono)">
        <input id="ar-d" placeholder="Descrizione">
        <button class="btn-add-confirm" onclick="bomAddManual()">+ Aggiungi</button>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <input id="ar-qty" type="number" min="1" value="1" style="width:60px;padding:7px;font-family:var(--mono);font-size:.76rem;border:1.5px solid var(--brd);border-radius:var(--r);background:var(--srf);outline:none">
        <span style="font-size:.74rem;color:var(--mut);line-height:36px">quantitÃ </span>
      </div>
    </div>`;

  document.getElementById('content').innerHTML=`
    <div class="stitle">BOM â€” ${esc(label)}</div>
    <div class="shint">Tutte le righe sono modificabili. Clicca su un campo per editarlo. Aggiungi o rimuovi righe liberamente.</div>
    ${addForm}
    <div class="bom-actions">
      <span class="bom-actions-label">Righe:</span>
      <button class="bom-add-btn" onclick="toggleAddRow()">+ Aggiungi riga</button>
      <button class="bom-add-btn" onclick="bomFromCatalog()">+ Dal catalogo</button>
    </div>
    <div class="bom-wrap">
      <table>
        <thead><tr><th>Cat.</th><th>Codice</th><th>Descrizione</th><th>QtÃ </th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    ${sug.length?`
    <div style="margin-top:2px;margin-bottom:5px" class="tlabel" style="font-family:var(--mono);font-size:.55rem;letter-spacing:.1em;text-transform:uppercase;color:var(--mut)">Suggeriti (clicca per aggiungere)</div>
    <table><thead><tr><th>Cat.</th><th>Codice</th><th>Desc.</th><th>QtÃ </th><th></th></tr></thead>
    <tbody>${sugRows}</tbody></table>`:''}
    <div class="cbar">
      <button class="cbtn" id="cb1" onclick="copyTab()">ğŸ“‹ Copia tabella</button>
      <button class="cbtn" id="cb2" onclick="copyOrdine()">ğŸ“„ Copia lista</button>
      <button class="cbtn" id="cb3" onclick="exportCSV()">â¬‡ Esporta CSV</button>
      <button class="cbtn acc" onclick="openSaveModal()">ğŸ’¾ Salva come Kit</button>
    </div>
    <div class="sep"></div>
    <div class="nav">
      ${W.s>0?`<button class="btn-b" onclick="wGo(W.s-1)">â† Modifica selezioni</button>`:`<button class="btn-b" onclick="setMode('kits')">â† Torna ai Kit</button>`}
      <button class="btn-r" onclick="setMode('wizard')">â†º Ricomincia</button>
    </div>`;
}

function bomRemove(i){BOM.splice(i,1);renderBOM();}
function bomAddSug(p){BOM.push({cat:p.cat,cod:p.cod,d:p.d,qty:p.qty||1});window._SUG=(window._SUG||[]).filter(s=>s.cod!==p.cod);renderBOM();}
function toggleAddRow(){SHOW_ADD_ROW=!SHOW_ADD_ROW;renderBOM();}
function bomAddManual(){
  const cat=document.getElementById('ar-cat').value.trim();
  const cod=document.getElementById('ar-cod').value.trim();
  const d=document.getElementById('ar-d').value.trim();
  const qty=parseInt(document.getElementById('ar-qty').value)||1;
  if(!cod&&!d){alert('Inserisci almeno codice o descrizione.');return;}
  BOM.push({cat:cat||'Articolo',cod,d,qty});
  SHOW_ADD_ROW=false;renderBOM();
}
// Variabili drawer catalogo
let _DQ='', _DF='Tutto', _DADD=0;

function bomFromCatalog(){
  _DQ=''; _DF='Tutto'; _DADD=0;
  renderCatalogDrawer();
}

function closeCatalogDrawer(){
  const el=document.getElementById('cat-drawer-root');
  if(el) el.remove();
  // Aggiorna la BOM a schermo dopo eventuali aggiunte
  renderBOM();
}

function renderCatalogDrawer(){
  // Rimuovi eventuale drawer esistente
  const prev=document.getElementById('cat-drawer-root');
  if(prev) prev.remove();

  const cats=['Tutto','Motore','Cavo','Spina','Inlet/Presa','Hawse','Contenitore','Accessorio','Guida rulli','Controllo','Pipe/Tubo'];
  const filt=CATALOG_ITEMS.filter(it=>{
    const mc=_DF==='Tutto'||it.cat===_DF;
    const q=_DQ.toLowerCase();
    return mc&&(!q||it.cod.toLowerCase().includes(q)||it.d.toLowerCase().includes(q));
  });

  const bomCods=new Set(BOM.map(r=>r.cod));

  const rows=filt.map(it=>{
    const inBom=bomCods.has(it.cod);
    return`<tr>
      <td><span class="pcat">${it.cat}</span></td>
      <td style="font-family:var(--mono);font-size:.72rem;color:var(--acc)">${esc(it.cod)}</span></td>
      <td>${esc(it.d)}</td>
      <td><button class="add-btn${inBom?' added':''}"
        onclick="drawerAdd(${JSON.stringify(it).replace(/"/g,'&quot;')})">
        ${inBom?'âœ“ in BOM':'+ aggiungi'}
      </button></td>
    </tr>`;
  }).join('');

  const backdrop=document.createElement('div');
  backdrop.id='cat-drawer-root';
  backdrop.className='cat-drawer-backdrop';
  // click sul backdrop chiude
  backdrop.addEventListener('click', e=>{ if(e.target===backdrop) closeCatalogDrawer(); });

  backdrop.innerHTML=`
    <div class="cat-drawer">
      <div class="cat-drawer-head">
        <div class="cat-drawer-title">+ Dal catalogo</div>
        <button class="cat-drawer-close" onclick="closeCatalogDrawer()">Ã—</button>
      </div>
      <div class="cat-drawer-body">
        <div class="cat-search">
          <input id="dq" placeholder="Cerca codice o descrizioneâ€¦" value="${esc(_DQ)}"
            oninput="_DQ=this.value;renderCatalogDrawer()">
        </div>
        <div class="cat-filter">${cats.map(c=>`
          <button class="cf${_DF===c?' on':''}" onclick="_DF='${c}';renderCatalogDrawer()">${c}</button>`).join('')}
        </div>
        <table>
          <thead><tr><th>Cat.</th><th>Codice</th><th>Descrizione</th><th></th></tr></thead>
          <tbody>${rows||`<tr><td colspan="4" style="text-align:center;padding:16px;color:var(--mut)">Nessun risultato</td></tr>`}</tbody>
        </table>
      </div>
      <div class="cat-drawer-footer" id="drawer-footer">
        ${_DADD>0?`âœ“ ${_DADD} articol${_DADD===1?'o':'i'} aggiunt${_DADD===1?'o':'i'} alla BOM`:'Seleziona gli articoli da aggiungere.'}
      </div>
    </div>`;

  document.body.appendChild(backdrop);

  // Mantieni focus e cursore nella ricerca
  setTimeout(()=>{
    const q=document.getElementById('dq');
    if(q){ q.focus(); if(_DQ) q.setSelectionRange(_DQ.length,_DQ.length); }
  }, 20);
}

function drawerAdd(item){
  const idx=BOM.findIndex(r=>r.cod===item.cod);
  if(idx>=0){
    BOM[idx].qty=(BOM[idx].qty||1)+1;
  } else {
    BOM.push({cat:item.cat, cod:item.cod, d:item.d, qty:1});
    _DADD++;
  }
  // Ri-renderizza solo il drawer (la BOM in background si aggiorna alla chiusura)
  renderCatalogDrawer();
}

// addToBOM: kept for compatibility, not used in drawer flow
function addToBOM(item){
  BOM.push({cat:item.cat,cod:item.cod,d:item.d,qty:1});
  renderBOM();
}

function wBind(){
  document.querySelectorAll('[data-k]').forEach(el=>{
    el.addEventListener('click',()=>{
      const k=el.dataset.k,v=el.dataset.v;
      if(k==='lun'){W.lun=JSON.parse(v);}
      else{
        W[k]=v;
        if(k==='motore'){W.ten=W.cavo=W.lun=W.conn=W.hawse=W.cont=null;W.conn_variant='main';}
        if(k==='cavo'){W.lun=W.conn=W.hawse=null;W.conn_variant='main';}
        if(k==='conn'){W.conn_variant=v;}
      }
      rWizard();
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rKits(){
  const uk=getUserKits();
  const all=[...uk.map(k=>({...k,user:true})),...PRESETS];
  document.getElementById('content').innerHTML=`
    <div class="stitle">Kit preconfigurati</div>
    <div class="shint">Scegli un kit standard o modifica/usa i tuoi kit salvati. Puoi importare kit da file CSV o da un link condiviso.</div>
    <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">
      <label class="cbtn" style="cursor:pointer">ğŸ“¥ Importa CSV<input type="file" accept=".csv" style="display:none" onchange="importCSVKit(this)"></label>
      <button class="cbtn" onclick="checkURLKit()">ğŸ”— Importa da link</button>
    </div>
    ${uk.length?`<div class="info gn">ğŸ’š Hai <strong>${uk.length} kit salvat${uk.length===1?'o':'i'}</strong> personalizzati (in cima, bordo verde).</div>`:''}
    <div class="kit-grid">${all.map(k=>kitCard(k)).join('')}</div>`;
}

function kitCard(k){
  const del=k.user?`<button class="kit-del" onclick="delKit('${k.id}',event)">Ã—</button>`:'';
  const tags=(k.tags||[]).map(t=>`<span class="tag ${t.includes('EU')?'g':t.includes('USA')?'gr':'n'}">${t}</span>`).join('');
  const items=(k.bom||[]).slice(0,5).map(i=>`<div>${i.cod} â€” ${i.d}</div>`).join('');
  const more=(k.bom||[]).length>5?`<div style="color:var(--acc)">+${k.bom.length-5} altri</div>`:'';
  const shareUrl=makeShareURL(k);
  return`
    <div class="kit-card ${k.user?'user-k':''}">
      <div class="kit-top"><div class="kit-name">${esc(k.name)}</div>${del}</div>
      <div class="kit-desc">${esc(k.desc||'')}</div>
      <div class="kit-tags">${tags}</div>
      <div class="kit-items">${items}${more}</div>
      <div class="kit-cta">
        <button class="btn-kit primary" onclick="useKit('${k.id}')">Apri BOM â†’</button>
        <button class="btn-kit share" onclick="copyShareLink('${k.id}')">ğŸ”— Condividi</button>
        ${k.user?`<button class="btn-kit sec" onclick="editKit('${k.id}')">âœ Modifica</button>`:''}
      </div>
    </div>`;}

function findKit(id){return getUserKits().find(k=>k.id===id)||PRESETS.find(k=>k.id===id);}

function useKit(id){
  const k=findKit(id);if(!k)return;
  BOM=k.bom.map(r=>({...r,qty:r.qty||1}));
  window._WLABEL=k.name;window._SUG=[];
  W.s=7;MODE='kit-detail';
  renderHNav();
  renderBOM(true);
}

function editKit(id){
  const k=getUserKits().find(k=>k.id===id);
  if(!k)return;
  BOM=k.bom.map(r=>({...r,qty:r.qty||1}));
  window._WLABEL=k.name;window._SUG=[];
  // Save back button to kits
  W.s=-1; // sentinel: back goes to kits
  MODE='kit-detail';
  renderHNav();
  renderBOM(true);
}

function rKitDetail(){renderBOM(true);}

function delKit(id,e){
  e.stopPropagation();
  if(!confirm('Eliminare questo kit?'))return;
  saveUserKits(getUserKits().filter(k=>k.id!==id));
  renderHNav();rKits();
}

// â”€â”€ URL SHARING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeShareURL(kit){
  const data=JSON.stringify({name:kit.name,desc:kit.desc,tags:kit.tags,bom:kit.bom});
  return location.href.split('?')[0]+'?kit='+btoa(unescape(encodeURIComponent(data)));
}

function copyShareLink(id){
  const k=findKit(id);if(!k)return;
  const url=makeShareURL(k);
  navigator.clipboard.writeText(url).then(()=>alert('Link copiato!\n\nChiunque apra questo link potrÃ  importare il kit.'));
}

function checkURLKit(){
  const params=new URLSearchParams(location.search);
  const raw=params.get('kit');
  if(!raw){alert('Nessun kit trovato nell\'URL corrente.\nCondividi un link generato con "ğŸ”— Condividi".');return;}
  importKitFromBase64(raw);
}

function importKitFromBase64(raw){
  try{
    const data=JSON.parse(decodeURIComponent(escape(atob(raw))));
    if(!data.name||!data.bom)throw new Error('Formato non valido');
    const kit={id:'u_'+Date.now(),user:true,name:data.name,desc:data.desc||'',tags:data.tags||[],bom:data.bom,savedAt:new Date().toLocaleDateString('it-IT')};
    if(confirm(`Importare kit "${data.name}" con ${data.bom.length} articoli?`)){
      const kits=getUserKits();kits.unshift(kit);saveUserKits(kits);
      renderHNav();rKits();
    }
  }catch(err){alert('Errore nel decodificare il kit: '+err.message);}
}

// Gestione URL kit integrata in initApp() â€” dopo il fetch dei dati

// â”€â”€ CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(){
  const rows=[['Categoria','Codice','Descrizione','Quantita'],...BOM.map(r=>[r.cat,r.cod,r.d,r.qty||1])];
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`cablemaster-${(window._WLABEL||'bom').replace(/[^a-z0-9]/gi,'_').toLowerCase()}.csv`;
  a.click();
}

function importCSVKit(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split('\n').filter(l=>l.trim());
    const header=lines[0].split(',').map(h=>h.replace(/"/g,'').trim().toLowerCase());
    const getCol=(row,name)=>{const i=header.findIndex(h=>h.includes(name));return i>=0?row[i].replace(/"/g,'').trim():''};
    const bom=lines.slice(1).map(line=>{
      const cols=line.split(',');
      return{cat:getCol(cols,'cat'),cod:getCol(cols,'cod'),d:getCol(cols,'desc'),qty:parseInt(getCol(cols,'quant'))||1};
    }).filter(r=>r.cod||r.d);
    if(!bom.length){alert('Nessun articolo trovato nel CSV.');return;}
    const name=file.name.replace('.csv','').replace(/_/g,' ');
    const kit={id:'u_'+Date.now(),user:true,name,desc:`Importato da ${file.name}`,tags:[],bom,savedAt:new Date().toLocaleDateString('it-IT')};
    if(confirm(`Importare kit "${name}" con ${bom.length} articoli?`)){
      const kits=getUserKits();kits.unshift(kit);saveUserKits(kits);
      renderHNav();rKits();
    }
  };
  reader.readAsText(file,'UTF-8');
  input.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATALOGO LIBERO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rCatalog(){
  const cats=['Tutto','Motore','Cavo','Spina','Inlet/Presa','Hawse','Contenitore','Accessorio','Guida rulli','Controllo','Pipe/Tubo'];
  const filt=CATALOG_ITEMS.filter(it=>{
    const mc=CAT_F==='Tutto'||it.cat===CAT_F;
    const q=CAT_Q.toLowerCase();
    return mc&&(!q||it.cod.toLowerCase().includes(q)||it.d.toLowerCase().includes(q));
  });
  const cc=Object.keys(CART).length;
  document.getElementById('content').innerHTML=`
    <div class="stitle">Catalogo articoli</div>
    <div class="shint">Filtra, cerca e aggiungi articoli alla lista ordine. ${cc?`<strong style="color:var(--grn)">${cc} art. selezionati.</strong> <a href="#" onclick="setMode('cart');return false" style="color:var(--acc)">â†’ Lista ordine</a>`:''}</div>
    <div class="cat-search"><input placeholder="Cerca codice o descrizioneâ€¦" value="${esc(CAT_Q)}" oninput="CAT_Q=this.value;rCatalog()" id="cq" autofocus></div>
    <div class="cat-filter">${cats.map(c=>`<button class="cf ${CAT_F===c?'on':''}" onclick="CAT_F='${c}';rCatalog()">${c}</button>`).join('')}</div>
    <table>
      <thead><tr><th>Cat.</th><th>Codice</th><th>Descrizione</th><th></th></tr></thead>
      <tbody>${filt.map(it=>{
        const ic=!!CART[it.cod];
        return`<tr>
          <td><span class="pcat">${it.cat}</span></td>
          <td><span class="pcode">${it.cod}</span></td>
          <td>${esc(it.d)}</td>
          <td><button class="add-btn ${ic?'added':''}" onclick='toggleCart(${JSON.stringify(it)})'>${ic?'âœ“ aggiunto':'+ aggiungi'}</button></td>
        </tr>`}).join('')}
        ${!filt.length?`<tr><td colspan="4" style="text-align:center;padding:18px;color:var(--mut)">Nessun risultato</td></tr>`:''}
      </tbody>
    </table>`;
  setTimeout(()=>{const q=document.getElementById('cq');if(q&&CAT_Q){q.focus();q.setSelectionRange(q.value.length,q.value.length);}},10);
  updateCartBar();
}

function toggleCart(it){
  if(CART[it.cod])delete CART[it.cod];else CART[it.cod]={...it,qty:1};
  rCatalog();renderHNav();
}
function updateCartBar(){
  const n=Object.keys(CART).length;
  document.getElementById('cart-n').textContent=n;
  document.getElementById('cart-bar').classList.toggle('show',n>0);
}

function rCart(){
  const items=Object.values(CART);
  if(!items.length){document.getElementById('content').innerHTML=`<div class="stitle">Lista ordine</div><div class="shint">Nessun articolo selezionato.</div><button class="btn-acc" onclick="setMode('catalog')">â†’ Vai al catalogo</button>`;return;}
  BOM=items.map(it=>({cat:it.cat,cod:it.cod,d:it.d,qty:it.qty||1}));
  window._WLABEL='Lista libera';window._SUG=[];W.s=-1;
  MODE='cart';
  renderHNav();renderBOM();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SALVA KIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSaveModal(){
  document.getElementById('kit-name-in').value=window._WLABEL||'';
  document.getElementById('kit-notes-in').value='';
  document.getElementById('save-modal').style.display='flex';
}
function closeModal(){document.getElementById('save-modal').style.display='none';}
function doSaveKit(){
  const name=document.getElementById('kit-name-in').value.trim();
  if(!name){alert('Inserisci un nome per il kit.');return;}
  const notes=document.getElementById('kit-notes-in').value.trim();
  if(!BOM.length){alert('BOM vuota.');return;}
  const tags=extractTags(name,BOM);
  const kit={id:'u_'+Date.now(),user:true,name,desc:notes||'Kit personalizzato.',notes,tags,bom:JSON.parse(JSON.stringify(BOM)),savedAt:new Date().toLocaleDateString('it-IT')};
  const kits=getUserKits();kits.unshift(kit);saveUserKits(kits);
  closeModal();renderHNav();
  if(confirm(`Kit "${name}" salvato!\n\nVuoi vedere i kit?`))setMode('kits');
}
function extractTags(name,bom){
  const t=[];
  ['CM4','CM7','CM8','CM9'].forEach(m=>{if(name.includes(m)||bom.some(r=>r.d.includes(m)))t.push(m);});
  ['30A','50A','63A','100A','150A','177A','200A'].forEach(a=>{if(name.includes(a))t.push(a);});
  if(name.toLowerCase().includes('eu')||name.includes('400V'))t.push('EU');
  if(name.toLowerCase().includes('usa'))t.push('USA');
  if(name.includes('12V'))t.push('12V');if(name.includes('24V'))t.push('24V');
  return[...new Set(t)];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPIA / EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyTab(){
  const txt='Categoria\tCodice\tDescrizione\tQty\n'+BOM.map(r=>`${r.cat}\t${r.cod}\t${r.d}\t${r.qty||1}`).join('\n');
  navigator.clipboard.writeText(txt).then(()=>flash('cb1','âœ“ Copiato','ğŸ“‹ Copia tabella'));
}
function copyOrdine(){
  const lines=[`ORDINE â€” ${window._WLABEL||''}`,'',...BOM.map(r=>`${r.qty||1}\t${r.cod}\t${r.d}`)];
  navigator.clipboard.writeText(lines.join('\n')).then(()=>flash('cb2','âœ“ Copiato','ğŸ“„ Lista'));
}
function flash(id,ok,orig){
  const b=document.getElementById(id);if(!b)return;
  b.textContent=ok;b.classList.add('ok');
  setTimeout(()=>{b.textContent=orig;b.classList.remove('ok');},2000);
}
const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _admCat  = null;   // copia locale del catalogo in editing
let _admTab  = 'editor';
let _admQ    = '';
let _admF    = 'Tutto';
let _admDiff = null;   // risultato ultimo import

// Accesso: triplo click sul logo header
let _admClicks=0,_admTimer=0;
document.querySelector('.hb').addEventListener('click',()=>{
  _admClicks++;
  clearTimeout(_admTimer);
  _admTimer=setTimeout(()=>{_admClicks=0;},600);
  if(_admClicks>=3){_admClicks=0;openAdmin();}
});

function openAdmin(){
  // deep-copy del catalogo in memoria per editing locale
  _admCat=JSON.parse(JSON.stringify({
    _meta:      window._catRaw?._meta||{version:'?'},
    motori:     DB.motori,
    cavi:       DB.cavi,
    connettori: DB.connettori,
    hawse:      DB.hawse,
    contenitori:DB.cont,
    catalogo:   [...CATALOG_ITEMS],
    kit_preset: PRESETS,
  }));
  document.getElementById('adm-ver').textContent='v'+(_admCat._meta.version||'?')+' Â· '+(_admCat._meta.updated||'');
  document.getElementById('admin-panel').classList.add('show');
  admTab('editor', document.querySelector('.adm-tab'));
}

function closeAdmin(){
  document.getElementById('admin-panel').classList.remove('show');
}

function admTab(tab, btn){
  _admTab=tab;
  document.querySelectorAll('.adm-tab').forEach(b=>b.classList.remove('on'));
  if(btn) btn.classList.add('on');
  document.getElementById('adm-export-bar').style.display=
    (tab==='editor')?'flex':'none';
  if(tab==='editor')  admRenderEditor();
  else if(tab==='import') admRenderImport();
  else if(tab==='audit')  admRenderAudit();
}

// â”€â”€ EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function admRenderEditor(){
  if(!_admCat){openAdmin();return;}
  const cats=['Tutto','Motore','Cavo','Spina','Inlet/Presa','Hawse','Contenitore','Accessorio','Guida rulli','Controllo','Pipe/Tubo'];
  const q=_admQ.toLowerCase();
  const all=_admCat.catalogo; // include anche attivo:false
  const filt=all.filter(a=>{
    const mc=_admF==='Tutto'||a.cat===_admF;
    return mc&&(!q||a.cod.toLowerCase().includes(q)||a.d.toLowerCase().includes(q));
  });

  const rows=filt.map((a,fi)=>{
    const ri=all.indexOf(a);
    const subbg=a.sostituito_da?'var(--gld2)':'';
    return`<tr class="${a.attivo===false?'inactive':''}">
      <td><span class="adm-cod">${esc(a.cod)}</span></td>
      <td><input class="adm-edit" value="${esc(a.d)}"
        oninput="_admCat.catalogo[${ri}].d=this.value;admMarkSaved(false)"></td>
      <td><span class="pcat">${esc(a.cat)}</span></td>
      <td style="text-align:center">
        <button class="adm-toggle ${a.attivo!==false?'on':'off'}"
          onclick="admToggleAttivo(${ri})"></button>
      </td>
      <td style="background:${subbg}">
        <input class="adm-sub-inp" placeholder="cod. sostituto"
          value="${esc(a.sostituito_da||'')}"
          oninput="_admCat.catalogo[${ri}].sostituito_da=this.value||null;admMarkSaved(false)">
      </td>
    </tr>`;
  }).join('');

  document.getElementById('adm-body').innerHTML=`
    <div class="adm-toolbar">
      <input class="adm-search" placeholder="Cerca codice o descrizioneâ€¦"
        value="${esc(_admQ)}" oninput="_admQ=this.value;admRenderEditor()">
      <button class="cbtn" onclick="admAddArticolo()">+ Nuovo articolo</button>
    </div>
    <div class="adm-filter">${cats.map(c=>
      `<button class="adm-cf${_admF===c?' on':''}" onclick="_admF='${c}';admRenderEditor()">${c}</button>`
    ).join('')}</div>
    <div style="font-family:var(--mono);font-size:.56rem;color:var(--mut);margin-bottom:8px">
      ${filt.length} articoli Â· <span style="color:var(--grn)">${all.filter(a=>a.attivo!==false).length} attivi</span> Â· 
      <span style="color:var(--mut)">${all.filter(a=>a.attivo===false).length} inattivi</span>
    </div>
    <table class="adm-table">
      <thead><tr>
        <th>Codice</th><th>Descrizione</th><th>Cat.</th>
        <th style="text-align:center">Attivo</th><th>Sostituito da</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  setTimeout(()=>{const s=document.querySelector('.adm-search');if(s&&_admQ){s.focus();s.setSelectionRange(_admQ.length,_admQ.length);}},10);
}

function admToggleAttivo(ri){
  const a=_admCat.catalogo[ri];
  a.attivo=(a.attivo===false)?true:false;
  admMarkSaved(false);
  admRenderEditor();
}

function admAddArticolo(){
  const cod=prompt('Codice nuovo articolo:');
  if(!cod||!cod.trim()) return;
  if(_admCat.catalogo.find(a=>a.cod===cod.trim())){alert('Codice giÃ  presente.');return;}
  _admCat.catalogo.push({cat:'Accessorio',cod:cod.trim(),d:'',attivo:true,sostituito_da:null});
  admMarkSaved(false);
  _admQ=cod.trim();
  admRenderEditor();
}

function admMarkSaved(saved){
  const el=document.getElementById('adm-save-status');
  if(!el) return;
  el.textContent=saved?'âœ“ Salvato':'â— Modifiche non esportate';
  el.style.color=saved?'var(--grn)':'var(--gld)';
}

// â”€â”€ IMPORT CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function admRenderImport(){
  document.getElementById('adm-body').innerHTML=`
    <div class="stitle" style="font-size:1.1rem;margin-bottom:6px">Import da CSV / Excel</div>
    <div class="shint">Carica un file CSV con colonne: <strong>Codice, Descrizione, Categoria</strong>.
    L'app confronta con il catalogo attuale e mostra le differenze prima di applicare.</div>
    <div style="border:2px dashed var(--brd);border-radius:var(--r);padding:28px;text-align:center;margin-bottom:16px">
      <div style="font-size:1.3rem;margin-bottom:8px">ğŸ“‚</div>
      <div style="font-size:.8rem;color:var(--mut);margin-bottom:12px">CSV con header: Codice, Descrizione, Categoria</div>
      <label class="cbtn acc" style="cursor:pointer">
        Scegli file CSV
        <input type="file" accept=".csv" style="display:none" onchange="admParseCSV(this)">
      </label>
    </div>
    <div id="adm-diff-result"></div>`;
}

function admParseCSV(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split(/\r?\n/).filter(l=>l.trim());
    if(!lines.length){alert('File vuoto.');return;}
    const header=lines[0].split(',').map(h=>h.replace(/"/g,'').trim().toLowerCase());
    const iCod =header.findIndex(h=>h.includes('cod'));
    const iDesc=header.findIndex(h=>h.includes('desc'));
    const iCat =header.findIndex(h=>h.includes('cat'));
    if(iCod<0){alert('Colonna Codice non trovata.');return;}

    const parseCell=(row,i)=>i>=0?(row[i]||'').replace(/^"|"$/g,'').trim():'';
    const incoming=lines.slice(1).map(line=>{
      const row=line.match(/(".*?"|[^,]+|(?<=,)(?=,)|(?<=,)$)/g)||line.split(',');
      return{cod:parseCell(row,iCod),d:parseCell(row,iDesc),cat:parseCell(row,iCat)||'Accessorio'};
    }).filter(r=>r.cod);

    const currentMap=Object.fromEntries((_admCat.catalogo||CATALOG_ITEMS).map(a=>[a.cod,a]));
    const incomingMap=Object.fromEntries(incoming.map(a=>[a.cod,a]));

    const nuovi      =incoming.filter(a=>!currentMap[a.cod]);
    const cambiati   =incoming.filter(a=>currentMap[a.cod]&&currentMap[a.cod].d!==a.d);
    const invariati  =incoming.filter(a=>currentMap[a.cod]&&currentMap[a.cod].d===a.d);
    const discontinuati=(_admCat.catalogo||CATALOG_ITEMS)
      .filter(a=>a.attivo!==false&&!incomingMap[a.cod]);

    _admDiff={nuovi,cambiati,invariati,discontinuati,incomingMap,currentMap,incoming};
    admRenderDiff();
  };
  reader.readAsText(file,'UTF-8');
  input.value='';
}

function admRenderDiff(){
  const d=_admDiff; if(!d) return;
  const el=document.getElementById('adm-diff-result');

  const secNew=d.nuovi.length?`
    <div class="diff-section">
      <div class="diff-head new">ğŸŸ¢ <span class="diff-count">${d.nuovi.length}</span> articoli nuovi</div>
      <div class="diff-rows">${d.nuovi.map(a=>`
        <div class="diff-row">
          <span class="diff-cod">${esc(a.cod)}</span>
          <span class="diff-new">${esc(a.d)}</span>
          <span style="font-family:var(--mono);font-size:.6rem;color:var(--mut)">${esc(a.cat)}</span>
        </div>`).join('')}</div>
    </div>`:'';

  const secChg=d.cambiati.length?`
    <div class="diff-section">
      <div class="diff-head changed">ğŸŸ¡ <span class="diff-count">${d.cambiati.length}</span> descrizioni cambiate</div>
      <div class="diff-rows">${d.cambiati.map(a=>`
        <div class="diff-row">
          <span class="diff-cod">${esc(a.cod)}</span>
          <span class="diff-old">${esc(d.currentMap[a.cod]?.d||'')}</span>
          <span class="diff-new">â†’ ${esc(a.d)}</span>
        </div>`).join('')}</div>
    </div>`:'';

  const secDis=d.discontinuati.length?`
    <div class="diff-section">
      <div class="diff-head removed">ğŸ”´ <span class="diff-count">${d.discontinuati.length}</span> non presenti nel CSV (saranno marcati inattivi)</div>
      <div class="diff-rows">${d.discontinuati.map(a=>`
        <div class="diff-row">
          <span class="diff-cod">${esc(a.cod)}</span>
          <span style="color:var(--mut)">${esc(a.d)}</span>
          <span></span>
        </div>`).join('')}</div>
    </div>`:'';

  const secOk=`
    <div class="diff-section">
      <div class="diff-head ok">âœ“ <span class="diff-count">${d.invariati.length}</span> articoli invariati</div>
    </div>`;

  const hasChanges=d.nuovi.length||d.cambiati.length||d.discontinuati.length;

  el.innerHTML=`
    <div style="font-family:var(--mono);font-size:.6rem;color:var(--mut);margin-bottom:12px">
      CSV analizzato: ${d.incoming.length} righe
    </div>
    <div class="diff-wrap">${secNew}${secChg}${secDis}${secOk}</div>
    ${hasChanges?`
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="cbtn acc" onclick="admApplyDiff()">âœ“ Applica modifiche</button>
      <button class="cbtn" onclick="document.getElementById('adm-diff-result').innerHTML=''">Annulla</button>
    </div>`:`<div class="info gn" style="margin-top:4px">âœ“ Catalogo giÃ  aggiornato â€” nessuna modifica necessaria.</div>`}`;
}

function admApplyDiff(){
  if(!_admDiff) return;
  const d=_admDiff;
  const cat=_admCat.catalogo||[];

  // Aggiungi nuovi
  d.nuovi.forEach(a=>cat.push({cod:a.cod,d:a.d,cat:a.cat,attivo:true,sostituito_da:null}));

  // Aggiorna cambiati
  d.cambiati.forEach(a=>{
    const ex=cat.find(x=>x.cod===a.cod);
    if(ex) ex.d=a.d;
  });

  // Marca discontinuati come inattivi
  d.discontinuati.forEach(a=>{
    const ex=cat.find(x=>x.cod===a.cod);
    if(ex) ex.attivo=false;
  });

  _admDiff=null;
  admMarkSaved(false);
  alert(`Applicate: ${d.nuovi.length} nuovi, ${d.cambiati.length} aggiornati, ${d.discontinuati.length} marcati inattivi.\nEsporta il JSON e sostituisci catalog.json nel repo per rendere permanenti le modifiche.`);
  admTab('editor', document.querySelectorAll('.adm-tab')[0]);
}

// â”€â”€ AUDIT KIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function admRenderAudit(){
  const allKits=[...getUserKits(), ...PRESETS];
  const catMap=Object.fromEntries((_admCat?.catalogo||CATALOG_ITEMS).map(a=>[a.cod,a]));

  const results=allKits.map(kit=>{
    const issues=[];
    (kit.bom||[]).forEach(row=>{
      const art=catMap[row.cod];
      if(!art){
        // Codice non in catalogo: potrebbe essere articolo esterno, non Ã¨ un errore
        issues.push({tipo:'external',cod:row.cod,d:row.d,msg:'Non in catalogo (articolo esterno o codice libero)'});
      } else if(art.attivo===false){
        const sub=art.sostituito_da;
        issues.push({tipo:'discontinued',cod:row.cod,d:row.d,
          msg:sub?`Discontinuato â†’ sostituito da ${sub}`:'Discontinuato â€” nessun sostituto indicato',
          sub});
      } else if(art.sostituito_da){
        issues.push({tipo:'renamed',cod:row.cod,d:row.d,
          msg:`Rinominato â†’ nuovo codice: ${art.sostituito_da}`,sub:art.sostituito_da});
      }
    });
    return{kit,issues};
  });

  const errCount=results.filter(r=>r.issues.some(i=>i.tipo==='discontinued')).length;
  const warnCount=results.filter(r=>r.issues.some(i=>i.tipo==='renamed')).length;
  const okCount=results.filter(r=>r.issues.length===0).length;

  const cards=results.map(({kit,issues})=>{
    const hasErr=issues.some(i=>i.tipo==='discontinued');
    const hasWarn=issues.some(i=>i.tipo==='renamed'||i.tipo==='external');
    const cls=hasErr?'err':hasWarn?'warn':'ok';
    const icon=hasErr?'ğŸ”´':hasWarn?'ğŸŸ¡':'âœ“';
    const issueHtml=issues.map(i=>`
      <div class="audit-issue">
        <span class="audit-issue-cod">${esc(i.cod)}</span>
        <span style="color:var(--mut)">${esc(i.msg)}</span>
        ${i.sub?`<button class="cbtn" style="padding:3px 8px;font-size:.54rem;margin-left:auto" 
          onclick="admAutoFix('${esc(kit.id)}','${esc(i.cod)}','${esc(i.sub)}')">Auto-fix</button>`:''}
      </div>`).join('');
    return`<div class="audit-kit ${cls}">
      <div class="audit-kit-name">${icon} ${esc(kit.name)} ${kit.user?'<span style="font-size:.65rem;opacity:.6">(tuo kit)</span>':'<span style="font-size:.65rem;opacity:.6">(preset)</span>'}</div>
      ${issues.length?issueHtml:`<div style="font-size:.74rem;color:var(--grn)">âœ“ Tutti gli articoli sono validi nel catalogo attuale.</div>`}
    </div>`;
  }).join('');

  document.getElementById('adm-body').innerHTML=`
    <div style="display:flex;gap:14px;margin-bottom:18px;flex-wrap:wrap">
      <div class="sc" style="border:1px solid var(--brd);border-radius:var(--r);padding:10px 16px;min-width:100px">
        <div class="sc-l">Kit totali</div><div class="sc-v">${allKits.length}</div>
      </div>
      <div class="sc" style="border:1px solid var(--red);border-radius:var(--r);padding:10px 16px;background:var(--red2);min-width:100px">
        <div class="sc-l" style="color:var(--red)">Con errori</div><div class="sc-v">${errCount}</div>
      </div>
      <div class="sc" style="border:1px solid var(--gld);border-radius:var(--r);padding:10px 16px;background:var(--gld2);min-width:100px">
        <div class="sc-l" style="color:var(--gld)">Con avvisi</div><div class="sc-v">${warnCount}</div>
      </div>
      <div class="sc" style="border:1px solid var(--grn);border-radius:var(--r);padding:10px 16px;background:var(--grn2);min-width:100px">
        <div class="sc-l" style="color:var(--grn)">OK</div><div class="sc-v">${okCount}</div>
      </div>
    </div>
    <div>${cards}</div>`;
}

function admAutoFix(kitId, oldCod, newCod){
  // Aggiorna il codice nel kit localStorage
  const kits=getUserKits();
  const kit=kits.find(k=>k.id===kitId);
  if(!kit){alert('Kit solo preset: non modificabile da qui.');return;}
  const row=kit.bom.find(r=>r.cod===oldCod);
  if(!row) return;
  const newArt=(_admCat?.catalogo||CATALOG_ITEMS).find(a=>a.cod===newCod);
  if(newArt&&newArt.d) row.d=newArt.d;
  row.cod=newCod;
  saveUserKits(kits);
  alert('Kit aggiornato. Riapri il kit per verificare.');
  admRenderAudit();
}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function admExportJSON(){
  if(!_admCat){alert('Nessun catalogo in editing.');return;}
  // Bump versione
  const now=new Date();
  const dateStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  const oldVer=String(_admCat._meta?.version||'2026.1');
  const parts=oldVer.split('.');
  parts[parts.length-1]=String((parseInt(parts[parts.length-1]||0)+1));
  _admCat._meta={..._admCat._meta,version:parts.join('.'),updated:dateStr};

  const json=JSON.stringify(_admCat,null,2);
  const blob=new Blob([json],{type:'application/json;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='catalog.json';
  a.click();
  admMarkSaved(true);
  document.getElementById('adm-ver').textContent='v'+_admCat._meta.version+' Â· '+dateStr;
  alert('catalog.json esportato.\nSostituisci il file nel repo e incrementa CACHE_NAME in sw.js per aggiornare tutti i dispositivi.');
}

function admExportCSV(){
  const all=_admCat?.catalogo||CATALOG_ITEMS;
  const rows=[['Codice','Descrizione','Categoria','Attivo','Sostituito_da'],
    ...all.map(a=>[a.cod,a.d,a.cat,a.attivo!==false?'SI':'NO',a.sostituito_da||''])];
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='catalogo-cablemaster.csv';
  a.click();
}

// â”€â”€â”€ AVVIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showLoader(msg){
  document.getElementById('content').innerHTML=
    '<div style="padding:48px 0;text-align:center;color:var(--mut)">' +
    '<div style="font-size:1.6rem;margin-bottom:12px">âš™ï¸</div>' +
    '<div style="font-family:var(--mono);font-size:.7rem;letter-spacing:.12em;text-transform:uppercase">'+(msg||'Caricamentoâ€¦')+'</div></div>';
}

function showError(msg){
  document.getElementById('content').innerHTML=
    '<div style="padding:48px 0;text-align:center">' +
    '<div style="font-size:1.6rem;margin-bottom:12px">âš ï¸</div>' +
    '<div style="color:var(--red);font-family:var(--mono);font-size:.75rem;margin-bottom:8px">'+msg+'</div>' +
    '<div style="font-size:.75rem;color:var(--mut)">Controlla che catalog.json e rules.json siano presenti.</div>' +
    '<button class="btn-n" style="margin-top:18px" onclick="initApp()">â†º Riprova</button></div>';
}

function hydrate(cat, rules){
  // Normalizza motori: supporta sia vecchio schema (t/od) sia nuovo (tensioni/od_max)
  const motori={};
  for(const [id,m] of Object.entries(cat.motori)){
    motori[id]={
      ...m,
      t:       m.tensioni||m.t||{},       // alias retrocompatibile
      tensioni:m.tensioni||m.t||{},
      od:      m.od_max||m.od||999,       // alias retrocompatibile
      od_max:  m.od_max||m.od||999,
      hawse:   m.hawse_ids||m.hawse||[],  // alias retrocompatibile
      hawse_ids:m.hawse_ids||m.hawse||[],
      cont:    m.cont_ids||m.cont||[],    // alias retrocompatibile
      cont_ids:m.cont_ids||m.cont||[],
      cavi:    m.cavi_ids||m.cavi||[],
      cavi_ids:m.cavi_ids||m.cavi||[],
    };
  }
  DB = {
    motori,
    cavi:       cat.cavi,
    connettori: cat.connettori,
    hawse:      cat.hawse,
    cont:       cat.contenitori,
  };
  PRESETS       = cat.kit_preset;
  CATALOG_ITEMS = cat.catalogo.filter(a => a.attivo !== false);
  RULES         = rules;
  window._catRaw = cat; // tenuto per l'admin panel
}

async function initApp(){
  showLoader('Caricamento catalogoâ€¦');
  try {
    const [catResp, rulesResp] = await Promise.all([
      fetch('./catalog.json'),
      fetch('./rules.json'),
    ]);
    if(!catResp.ok)   throw new Error('catalog.json: ' + catResp.status + ' ' + catResp.statusText);
    if(!rulesResp.ok) throw new Error('rules.json: '   + rulesResp.status + ' ' + rulesResp.statusText);
    const [cat, rules] = await Promise.all([catResp.json(), rulesResp.json()]);
    hydrate(cat, rules);
    const raw = new URLSearchParams(location.search).get('kit');
    if(raw) setTimeout(()=>importKitFromBase64(raw), 400);
    render();
  } catch(err){
    console.error('initApp:', err);
    showError(err.message);
  }
}

initApp();

</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }
</script>

</body>
</html>
